# Программное обеспечение для создания эффектов звездного неба на светодиодной ленте WS2812
## Аппаратная часть
Рекомендуется использовать плату [led-controller](https://github.com/fatum2996/led-controller).
## Программная часть
### Эффекты
#### Уровень 1
Хаотичная радуга
#### Уровень 2
0 
1
2
### Инициализация
#### Настройка пинов
Пины BIT0-BIT4, ACK - для связи со второй платой Arduino-радиоприемником.
Пины DATA_PIN-DATA_PIN5 - подключение лент с эффектами неба
Пин DATA_COMET_PIN - подключение ленты с эффектами комет
#### Настройка синуса и др.
sawValues[] - массив, длиной равный количеству светодиодов в ленте неба, заполняется случайными индексами, с которых начнутся эффекты второго уровня, для каждого из светодиодов. По индексам подбирается начальное значение массива sin256[]
sin256[] - массив значений синуса, длиной 256 символов, от 0 до 255
sin5[] - массив, в котором каждому светодиоду ставится в соответствие один из 5 синусов, сдвинутых друг относительно друга по времени, значения от 0 до 4
leds_brightness[] - массив, в котором задается яркость светодиодов, инициализируется средним значением 150
leds_chaos[] - массив для эффекта хаотичной радуги, в котором с помощью функции shuffleArray() случайным образом определяется порядок выведения эффекта радуги, не по очереди, а в хаотичных местах
#### Настройка кнопок
Для обработки кнопок используется библиотека OneButton. Используются две кнопки btn_mode (режим) и btn_saw (режим 2 уровня). Для кнопок активный уровень низкий, подтяжка включена.
Для кнопки btn_mode предусмотрены обработчики щелчка, долгого нажатия и двойного щелчка.
Щелчок переключает режим в текущей группе 1 уровня.
Длинное нажатие включает и выключает систему.
Двойной щелчок переключает группы режимов 1 уровня.
Щелчок по кнопке btn_saw переключает режимы 2 уровня.
#### Настройка комет
Настраиваются кометы: массив структур cometsSettings[] состоит из следующих полей:

 - cometStepTimer - шаг между перемещенеиями кометы
 - cometTail - длина хвоста
 - cometBrightness - яркость головы
 - cometReverse - направление полета
 - cometLaunchTimer - время между запусками
cometCounter[] - счетчик для полета кометы
cometOver[] - флаг окончания полета
cometState[] - флаг того, что комета в процессе полета
Настраиваются верхний и нижний уровней синуса 1 и 2.
Читается из энергонезависимой памяти уровень 1 (ячейка #0), уровень 2 (ячейка #1), предыдущее значение уровня 1 (ячейка #2).
Слайсы радуги и эффектов устанавливаются по умолчанию.
### Основной цикл
#### Опрос радиоприемника
Каждые 100 мс опрашивается радиоприемник (асинхронный обмен, 5 инф. битов от приемника и флаг подтверждения от мастера).
После получения данных устанавливается флаг ACK, если на линии нули - сбрасывается. Принятый код дополняется числом 6912 для совместимости.
##### Код 6913, кнопка ON
Уровень 1 - равен предыдущему
Флаг выключения = 0
##### Код 6914, кнопка AUTO
Переключаем уровень 2 функцией nextSaw
##### Код 6915, кнопка OFF
Запоминается значение уровня 1 в предыдущее. Уровень 1 = 0. Флаг выключения = 1.
##### Код 6917, кнопка М+, 6920 кнопка М-
Переключение уровня 1 пультом:
Если режим - статичный цвет - перейти на следующую группу режимов - динамические эффекты, код первого динамического эффекта colorCount+1.
Если находимся в динамических эффектах - переключаться между ними
При переключении слайсы возвращаются к значениям по умолчанию
##### Код 6922-6932, кнопки с цветами
Установка уровня 1 от 2 до 12, статичные цвета
##### Код 6933, кнопка белый цвет
Установка уровня 1 в 1, белый цвет
##### Код 6916, кнопка S+, 6919 кнопка S-
Переключение слайсов
##### Код 6918, кнопка BR+, 6921 кнопка BR-
Убавление и прибавление яркости с ограничениями
Значение кода по умолчанию - игнор. Сброс принятых данных.
#### Обработка уровня 1
##### Диапазон статичных цветов 
Всем пикселям установить статичный цвет из таблицы моноцветов monocolorTable[]
##### Динамические режимы
###### Код 13-16, радуга, космос, лето, осень
Используется встроенная функция fill_palette() - в нее передается массив зон, количество зон, переменный индекс, слайс и имя палитры. Каждый шаг уровня 1 индекс увеличивается
###### Код 17, сердцебиение
Используется HSV модель, каждые 25 шагов меняется цвет, каждый 1 шаг происходит изменение яркости по описанной модели, heartX - индекс оси X графика изменения яркости сердцебиения, heartBrightness - значение яркости, ось Y.
###### Код 18, хаотичная радуга
Если перешли с другого режима - перемешиваем массив, пишем сразу в leds_temp, а не в зоны. Хаос запишем при переносе в leds.
Если не режим хаоса, то копируем зоны в пиксели
#### Обработка уровня 2
##### Уровень 2 = 1,2
Для каждого из 5 синусов свой счетчик времени, level2_ms1_X. Заполняем массив яркости для всех светодиодов: если светодиоду назначен этот синус, яркость функция разницы между максимумом и минимумом, умноженная на значение синуса, с добавлением минимумам.
Для режима 1 и 2 меняются переменные времени, максимум и минимум.
##### Уровень 2 = 0
Присвоить всем светодиодам яркость по умолчанию
#### Переписываем leds_temp в leds
Меняя яркость как в leds_brightness, раскидываем leds_chaos
#### Настроечная таблица
Для отдельных пикселей есть настроечная таблица с корректировкой яркости
#### Созвездия
Если система выключена, записываем черным, если включена:
перебираем созвездия и светодиоды в них, записывая цвет из SZVColor и масштабируя яркость по разным каналам defaulSZVBrightnessR, defaulSZVBrightnessG, defaulSZVBrightnessB.
#### Кометы
Если система включена последовательно со сдвигом времени даем разрешения на запуск.
Проверяем, есть ли текущая комета.
Если полет закончился:
 - сбрасываем флаг полета
 - рандомим параметры кометы
 - все светодиоды кометы выключаем.
Если сработал таймер запуска cometLaunchTimer, включаем состояние полета.
Если установлено состояние полета:
 - каждый шаг кометы по времени делаем магию (WTF?)
Делаем 	FastLED.show() и тики кнопками.
### Описание функций
#### nextsaw()
Переключение уровня 2 - 0, 1, 2
#### copyZonesToPixels()
Переносим значения светодиодов из зон в leds_temp

## TODO:
- добавить кометы из ветки fit, launch4_enable-переписать
- выкинуть переменную changedState, level2_ms
- убрать Serial.println
- посчитать, сколько длится полное прохождение синуса из level2_ms1_X * 255
- версия с другим уровнем 2.
